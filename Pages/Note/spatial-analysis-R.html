<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="R语言空间分析 - NEGIAO的技术笔记，涵盖R语言在GIS数据处理、空间统计和可视化方面的应用。">
    <meta name="keywords" content="R语言, 空间分析, GIS, 数据可视化, sf, raster, NEGIAO">
    <meta name="author" content="NEGIAO">
    <meta name="theme-color" content="#0D1117">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="article">
    <meta property="og:url" content="https://negiao.github.io/Pages/Note/spatial-analysis-R.html">
    <meta property="og:title" content="R语言空间分析 - NEGIAO">
    <meta property="og:description" content="R语言空间分析 - NEGIAO的技术笔记，涵盖R语言在GIS数据处理、空间统计和可视化方面的应用。">
    <meta property="og:image" content="https://negiao.github.io/Pages/avatar.jpg">

    <title>R语言空间分析 - NEGIAO</title>
    <link rel="icon" type="image/png" href="/images/icon.png">
    <link rel="shortcut icon" type="image/png" href="/images/icon.png">
    <link rel="stylesheet" href="../style.css">
    <link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/highlight.js/11.7.0/styles/atom-one-dark.min.css">
    <link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.loli.net/ajax/libs/marked/9.1.2/marked.min.js"></script>
    <script defer src="../notes-toc.js"></script>
    <script defer src="../main-enhanced.js"></script>
    
    <!-- Google Analytics -->
    <script>
    window.addEventListener('load', function() {
      setTimeout(function() {
        var script = document.createElement('script');
        script.src = 'https://www.googletagmanager.com/gtag/js?id=G-KYJ7Y4LE2N';
        script.async = true;
        
        // 添加加载失败的处理
        script.onerror = function() {
            console.log('国内无法访问该功能: Google Analytics');
        };
        
        document.head.appendChild(script);
        
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-KYJ7Y4LE2N');
      }, 3000);
    });
    </script>
    <style>
        /* New TOC Toggle Button */
        .toc-toggle-btn {
            position: fixed;
            bottom: 90px;
            right: 30px;
            width: 45px;
            height: 45px;
            background: var(--surface-elevated);
            border: 1px solid var(--border);
            border-radius: 50%;
            color: var(--text);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1000;
            box-shadow: var(--shadow-lg);
            transition: all 0.3s ease;
        }

        .toc-toggle-btn:hover {
            background: var(--primary);
            color: white;
            transform: scale(1.1);
            box-shadow: 0 0 15px rgba(0, 217, 255, 0.4);
        }

        /* Hidden state for TOC */
        .note-toc.note-toc--hidden {
            transform: translateY(-50%) translateX(150%);
            opacity: 0;
            pointer-events: none;
        }
        
        /* Ensure transition matches */
        .note-toc {
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease;
        }

        @media (max-width: 768px) {
            .toc-toggle-btn {
                bottom: 80px;
                right: 20px;
            }
            
            /* Force fixed positioning on mobile to support toggle behavior */
            .note-toc {
                position: fixed !important;
                top: 50% !important;
                right: 20px !important;
                width: 260px !important;
                max-height: 60vh !important;
                transform: translateY(-50%) !important;
                z-index: 1050 !important;
                order: unset !important;
                box-shadow: 0 10px 40px rgba(0,0,0,0.5) !important;
            }

            /* Hidden state for mobile */
            .note-toc.note-toc--hidden {
                transform: translateY(-50%) translateX(150%) !important;
                opacity: 0 !important;
                pointer-events: none;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="navbar__container">
            <a href="../../index.html" class="navbar__brand">NEGIAO</a>
            <a href="../notes.html" class="btn btn--secondary">返回索引</a>
        </div>
    </nav>

    <main class="container section note-layout">
        <aside class="note-toc card" aria-label="文章章节目录">
            <nav class="note-toc__nav" id="note-toc"></nav>
        </aside>

        <!-- New TOC Toggle Button -->
        <button id="toc-toggle-btn" class="toc-toggle-btn" aria-label="切换目录显示">
            <i class="fas fa-times"></i>
        </button>

        <article class="note-content card" id="note-content">
            <script type="text/markdown" id="note-markdown">
# R语言空间分析

## 基础环境配置

### 安装必要的R包

```r
# 安装空间分析相关包
install.packages(c("sf", "sp", "rgdal", "raster", "tmap", "leaflet", "ggplot2"))

# 载入包
library(sf)
library(sp) 
library(rgdal)
library(raster)
library(tmap)
library(leaflet)
library(ggplot2)
```

## 空间数据读取与处理

### 读取Shapefile文件

```r
# 读取shapefile
cities <- st_read("data/cities.shp")

# 查看数据结构
str(cities)
head(cities)

# 查看坐标参考系统
st_crs(cities)
```

### 坐标系转换

```r
# 转换到WGS84地理坐标系
cities_wgs84 <- st_transform(cities, crs = 4326)

# 转换到投影坐标系(以UTM Zone 50N为例)
cities_utm <- st_transform(cities, crs = 32650)

# 检查转换结果
st_crs(cities_utm)
```

## 空间分析操作

### 缓冲区分析

```r
# 创建500米缓冲区
buffer_500m <- st_buffer(cities_utm, dist = 500)

# 创建多级缓冲区
buffer_multi <- st_buffer(cities_utm, 
                         dist = c(500, 1000, 2000))

# 可视化缓冲区
plot(st_geometry(buffer_500m), 
     col = "lightblue", 
     main = "500米缓冲区分析")
plot(st_geometry(cities_utm), 
     col = "red", 
     pch = 16, 
     add = TRUE)
```

### 空间叠加分析

```r
# 点在面内查询
result <- st_within(points, polygons)

# 空间相交
intersect_result <- st_intersection(layer1, layer2)

# 空间联合
union_result <- st_union(polygons)

# 计算面积(需要投影坐标系)
polygons$area_km2 <- as.numeric(st_area(polygons)) / 1000000
```

### 距离计算

```r
# 计算点之间的距离矩阵
dist_matrix <- st_distance(cities_utm)

# 计算到最近邻的距离
nearest_dist <- apply(dist_matrix, 1, function(x) min(x[x > 0]))

# 添加到数据框
cities_utm$nearest_dist <- as.numeric(nearest_dist)
```

## 空间可视化

### 使用ggplot2绘图

```r
# 基础空间图
ggplot(cities_wgs84) +
  geom_sf(aes(color = population, size = population)) +
  scale_color_viridis_c() +
  theme_minimal() +
  labs(title = "城市人口分布图",
       color = "人口数量",
       size = "人口数量")
```

### 使用tmap制作专题地图

```r
# 设置tmap模式
tmap_mode("plot")  # 静态地图
# tmap_mode("view") # 交互式地图

# 创建专题地图
tm_shape(provinces) +
  tm_polygons("GDP", 
              style = "quantile",
              palette = "Blues",
              title = "GDP (万元)") +
  tm_shape(cities) +
  tm_dots("population", 
          size = 0.8,
          col = "red",
          title.size = "人口") +
  tm_layout(title = "省市经济与人口分布图",
            title.position = c("center", "top"))
```

### 交互式地图

```r
# 使用leaflet创建交互式地图
leaflet(cities_wgs84) %>%
  addTiles() %>%
  addCircleMarkers(
    radius = ~sqrt(population)/100,
    color = "red",
    fillOpacity = 0.7,
    popup = ~paste("城市:", name, "<br>",
                   "人口:", population)
  ) %>%
  addLegend(position = "bottomright",
            title = "城市人口",
            colors = "red",
            labels = "城市位置")
```

## 空间统计分析

### 空间自相关分析

```r
# 安装和载入spdep包
library(spdep)

# 构建空间权重矩阵
coords <- st_coordinates(st_centroid(polygons))
nb <- knn2nb(knearneigh(coords, k = 6))
w <- nb2listw(nb, style = "W")

# 计算Moran's I
moran_result <- moran.test(polygons$gdp, w)
print(moran_result)

# 局部空间自相关(LISA)
lisa <- localmoran(polygons$gdp, w)
polygons$lisa_pvalue <- lisa[,5]
polygons$lisa_cluster <- ifelse(lisa[,5] < 0.05, "显著", "不显著")
```

### 热点分析

```r
# Getis-Ord Gi*统计
gi_star <- localG(polygons$gdp, w)
polygons$gi_star <- as.numeric(gi_star)

# 分类热点和冷点
polygons$hotspot <- ifelse(polygons$gi_star > 1.96, "热点",
                  ifelse(polygons$gi_star < -1.96, "冷点", "无显著性"))

# 可视化热点分析结果
ggplot(polygons) +
  geom_sf(aes(fill = hotspot)) +
  scale_fill_manual(values = c("热点" = "red", 
                              "冷点" = "blue", 
                              "无显著性" = "grey")) +
  theme_void() +
  labs(title = "GDP热点分析", fill = "类型")
```

## 栅格数据处理

### 栅格数据读取

```r
# 读取栅格数据
dem <- raster("data/elevation.tif")

# 查看栅格信息
print(dem)
plot(dem, main = "数字高程模型")
```

### 栅格计算

```r
# 计算坡度
slope <- terrain(dem, opt = "slope", unit = "degrees")

# 计算坡向
aspect <- terrain(dem, opt = "aspect", unit = "degrees")

# 栅格重分类
slope_class <- cut(slope, 
                   breaks = c(0, 5, 15, 25, 90),
                   labels = c("平缓", "缓坡", "陡坡", "急坡"))

# 栅格叠加分析
stack_layers <- stack(dem, slope, aspect)
names(stack_layers) <- c("elevation", "slope", "aspect")
```

## 实际应用案例

### 商业选址分析

```r
# 1. 数据准备
shops <- st_read("data/existing_shops.shp")
population <- st_read("data/population_districts.shp") 
roads <- st_read("data/main_roads.shp")

# 2. 缓冲区分析 - 竞争对手分析
competitor_buffer <- st_buffer(shops, dist = 1000)

# 3. 可达性分析 - 距主要道路距离
candidate_points$road_dist <- as.numeric(
  st_distance(candidate_points, roads)
)

# 4. 综合评分
candidate_points$score <- 
  (population_density * 0.4) +         # 人口密度权重40%
  (1/road_accessibility * 0.3) +       # 交通便利性30%
  (1/competitor_density * 0.3)         # 竞争密度30%

# 5. 选址推荐
best_locations <- candidate_points[
  candidate_points$score > quantile(candidate_points$score, 0.8), 
]
```

## 性能优化技巧

### 大数据处理

```r
# 使用data.table提高处理速度
library(data.table)

# 空间索引加速查询
library(lwgeom)
st_make_valid()  # 修复无效几何体

# 简化几何体减少计算量
simplified <- st_simplify(complex_polygons, dTolerance = 100)

# 并行处理
library(parallel)
cl <- makeCluster(detectCores() - 1)
results <- parLapply(cl, data_list, analysis_function)
stopCluster(cl)
```

### 内存管理

```r
# 分块处理大型栅格
raster_blocks <- blockSize(large_raster)
for(i in 1:raster_blocks$n) {
  # 逐块处理
  block_data <- getValues(large_raster, 
                         row = raster_blocks$row[i],
                         nrows = raster_blocks$nrows[i])
  # 处理数据...
}

# 及时清理内存
rm(large_objects)
gc()
```
</script>
        </article>
    </main>

    <!-- Load highlight.js with defer to improve page load performance -->
    <script src="https://cdnjs.loli.net/ajax/libs/highlight.js/11.7.0/highlight.min.js" defer></script>
    
    <script>
        // Optimized markdown rendering
        document.addEventListener('DOMContentLoaded', function() {
            // Process markdown asynchronously for better performance
            setTimeout(function() {
                const src = document.getElementById('note-markdown');
                if (!src) return;
                
                // Extract markdown content
                const md = src.textContent || src.innerText || '';
                
                // Process markdown in chunks for better responsiveness
                processMarkdown(md, function(html) {
                    const container = document.getElementById('note-content');
                    if (!container) return;
                    
                    // Insert the HTML
                    container.innerHTML = html;
                    
                    // Build table of contents
                    if (window.buildNoteTOC) {
                        requestAnimationFrame(function() {
                            window.buildNoteTOC();
                        });
                    }
                    
                    // Apply syntax highlighting
                    if (window.hljs) {
                        // Use requestIdleCallback for non-critical task if available
                        (window.requestIdleCallback || setTimeout)(function() {
                            container.querySelectorAll('pre code').forEach((block) => {
                                hljs.highlightBlock(block);
                            });
                        }, { timeout: 500 });
                    } else {
                        // Wait for highlight.js to load
                        window.onhljsready = function() {
                            container.querySelectorAll('pre code').forEach((block) => {
                                hljs.highlightBlock(block);
                            });
                        };
                    }
                });
            }, 0);
        });
        
        // Process markdown in chunks for better UI responsiveness
        function processMarkdown(md, callback) {
            // Use requestAnimationFrame to avoid blocking the main thread
            requestAnimationFrame(function() {
                let html;
                try {
                    // Use available markdown parser
                    if (window.marked) {
                        html = window.marked.parse(md);
                    } else if (window.markdownit) {
                        html = window.markdownit().render(md);
                    } else {
                        html = md; // Fallback
                    }
                    callback(html);
                } catch (e) {
                    console.error('Error parsing markdown:', e);
                    callback('<p>Error parsing markdown content.</p>');
                }
            });
        }
        
        function initTocToggle() {
            const toc = document.querySelector('.note-toc');
            const toggleBtn = document.getElementById('toc-toggle-btn');
            const icon = toggleBtn.querySelector('i');
            
            // Check localStorage for saved state
            const isHidden = localStorage.getItem('toc-hidden') === 'true';
            
            // Initial state
            if (isHidden) {
                toc.classList.add('note-toc--hidden');
                icon.classList.remove('fa-times');
                icon.classList.add('fa-list');
            } else {
                icon.classList.remove('fa-list');
                icon.classList.add('fa-times');
            }

            toggleBtn.addEventListener('click', () => {
                toc.classList.toggle('note-toc--hidden');
                
                // Update icon
                if (toc.classList.contains('note-toc--hidden')) {
                    icon.classList.remove('fa-times');
                    icon.classList.add('fa-list');
                    localStorage.setItem('toc-hidden', 'true');
                } else {
                    icon.classList.remove('fa-list');
                    icon.classList.add('fa-times');
                    localStorage.setItem('toc-hidden', 'false');
                }
            });
        }
        
        // Call initialization
        document.addEventListener('DOMContentLoaded', initTocToggle);
        
        // Set up highlight.js load callback
        if (typeof hljs === 'undefined') {
            window.addEventListener('load', function() {
                if (typeof hljs !== 'undefined' && typeof window.onhljsready === 'function') {
                    window.onhljsready();
                }
            });
        }
    </script>
</body>
</html>
